<%- include('partials/header') %>
<link href="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.snow.css" rel="stylesheet" />

<section class="auth-box wide">
  <h1><%= product ? t('admin.edit_product') : t('admin.create_product') %></h1>
  <form method="post" action="<%= action %>" class="form-col" enctype="multipart/form-data">
    <label><%= t('admin.name') %></label>
    <input type="text" name="name" value="<%= product ? product.name : '' %>" required />

    <label><%= t('admin.description') %></label>
    <div id="description-editor" class="rich-editor"></div>
    <input type="hidden" name="description" id="description-input" />

    <label><%= t('admin.category') %></label>
    <select name="category" required>
      <option value="Phone" <%= product && product.category === 'Phone' ? 'selected' : '' %>><%= t('category.phone') %></option>
      <option value="Accessory" <%= product && product.category === 'Accessory' ? 'selected' : '' %>><%= t('category.accessory') %></option>
    </select>

    <label><%= t('admin.price') %></label>
    <input type="number" name="price" step="0.01" min="0" value="<%= product ? product.price : 0 %>" required />

    <label><%= t('admin.stock') %></label>
    <input type="number" name="stock" min="0" value="<%= product ? product.stock : 0 %>" required />

    <label><%= t('admin.upload_image') %></label>
    <input type="file" name="image_file" accept="image/*" />

    <% if (product && product.image_url) { %>
    <img src="<%= product.image_url %>" alt="<%= t('admin.current_image') %>" class="product-img" style="max-width: 260px; height: auto;" />
    <% } %>

    <button class="btn" type="submit"><%= product ? t('admin.update_product') : t('admin.create_product_btn') %></button>
  </form>
</section>

<script src="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.min.js"></script>
<script>
  (function () {
    const editorEl = document.getElementById('description-editor');
    const hiddenInput = document.getElementById('description-input');
    const form = editorEl.closest('form');
    const initialHtml = <%- JSON.stringify(product ? product.description : '') %>;

    const quill = new Quill(editorEl, {
      theme: 'snow',
      placeholder: 'Nhập mô tả sản phẩm...',
      modules: {
        toolbar: [
          [{ header: [1, 2, 3, false] }],
          ['bold', 'italic', 'underline', 'strike'],
          [{ color: [] }, { background: [] }],
          [{ list: 'ordered' }, { list: 'bullet' }],
          [{ align: [] }],
          ['link', 'image'],
          ['clean']
        ]
      }
    });

    quill.root.innerHTML = initialHtml || '';
    hiddenInput.value = quill.root.innerHTML;

    form.addEventListener('submit', function (e) {
      hiddenInput.value = quill.root.innerHTML;
      const plainText = quill.getText().trim();
      if (!plainText) {
        e.preventDefault();
        alert('Vui lòng nhập mô tả sản phẩm.');
      }
    });
  })();
</script>

<%- include('partials/footer') %>
